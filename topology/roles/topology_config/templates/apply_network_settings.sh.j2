#!/bin/bash

# Attach hierarchical token buffer qdisc to internal testbed interface and configure outgoing bandwidth limit
tc qdisc add dev eth1 root handle 1: htb
tc class add dev eth1 parent 1: classid 1:1 htb rate {{ hostvars[inventory_hostname].testbed_config.bandwidth_out }}mbps

# For each target ip add filter and apply configured delay
{% for delay_path in hostvars[inventory_hostname].testbed_config.delay_paths %}
tc filter add dev eth1 protocol ip parent 1:0 u32 match ip dst {{ delay_path.target }} classid 1:{{ loop.index }}
tc qdisc add dev eth1 parent 1:{{ loop.index }} handle 2{{ loop.index }}: netem delay {{ delay_path.value }}000
{% endfor %}